<UserControl x:Class="STK_ToolBox.View.IOCheckControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">

    <UserControl.Resources>
        <!-- 색상 팔레트 -->
        <SolidColorBrush x:Key="MintBrush" Color="#18C29C"/>
        <SolidColorBrush x:Key="CheckedRowBrush" Color="#EAFBF5"/>
        <SolidColorBrush x:Key="SelectedRowBrush" Color="#E6F1FF"/>
        <SolidColorBrush x:Key="SelectedRowText" Color="#0A0A0A"/>
        <SolidColorBrush x:Key="GridBorderBrush" Color="#D0D7E2"/>
        <SolidColorBrush x:Key="ColBgName"   Color="#F7FAFF"/>
        <SolidColorBrush x:Key="ColBgOutput" Color="#FFF4E6"/>

        <!-- 텍스트/버튼 -->
        <Style x:Key="IoNameText" TargetType="TextBlock">
            <Setter Property="Foreground" Value="{DynamicResource {x:Static SystemColors.ControlTextBrushKey}}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding CurrentState}" Value="True">
                    <Setter Property="Foreground" Value="{StaticResource MintBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding IsBContact}" Value="True">
                    <Setter Property="Foreground" Value="{StaticResource MintBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="AddrText" TargetType="TextBlock">
            <Setter Property="FontFamily" Value="Consolas"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
        </Style>

        <Style x:Key="ToggleBtnStyle" TargetType="Button">
            <Setter Property="Padding" Value="10,4"/>
            <Setter Property="MinWidth" Value="86"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Focusable" Value="False"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding CurrentState}" Value="True">
                    <Setter Property="Content" Value="Turn OFF"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding CurrentState}" Value="False">
                    <Setter Property="Content" Value="Turn ON"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding CanToggle}" Value="False">
                    <Setter Property="IsEnabled" Value="False"/>
                    <Setter Property="Opacity" Value="0.45"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- DataGrid 행/셀 -->
        <Style x:Key="RowStyle" TargetType="DataGridRow">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{DynamicResource {x:Static SystemColors.ControlTextBrushKey}}"/>
            <Setter Property="MinHeight" Value="30"/>
            <Setter Property="FontSize" Value="14"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsChecked}" Value="True">
                    <Setter Property="Background" Value="{StaticResource CheckedRowBrush}"/>
                </DataTrigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{StaticResource SelectedRowBrush}"/>
                    <Setter Property="Foreground" Value="{StaticResource SelectedRowText}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="CellStyle" TargetType="DataGridCell">
            <Setter Property="Padding" Value="12,2,12,2"/>
            <Setter Property="BorderBrush" Value="{StaticResource GridBorderBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Foreground" Value="{DynamicResource {x:Static SystemColors.ControlTextBrushKey}}"/>
            <Setter Property="FontSize" Value="14"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsChecked}" Value="True">
                    <Setter Property="Background" Value="{StaticResource CheckedRowBrush}"/>
                </DataTrigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Foreground" Value="{StaticResource SelectedRowText}"/>
                    <Setter Property="Background" Value="{StaticResource SelectedRowBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="CellStyleNameCol" TargetType="DataGridCell" BasedOn="{StaticResource CellStyle}">
            <Setter Property="Background" Value="{StaticResource ColBgName}"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsChecked}" Value="True">
                    <Setter Property="Background" Value="{StaticResource CheckedRowBrush}"/>
                </DataTrigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{StaticResource SelectedRowBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="CellStyleOutputCol" TargetType="DataGridCell" BasedOn="{StaticResource CellStyle}">
            <Setter Property="Background" Value="{StaticResource ColBgOutput}"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsChecked}" Value="True">
                    <Setter Property="Background" Value="{StaticResource CheckedRowBrush}"/>
                </DataTrigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{StaticResource SelectedRowBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- 한쪽(16개) 템플릿 -->
        <DataTemplate x:Key="SixteenGridSideTemplate16">
            <DataGrid ItemsSource="{Binding}"
                      AutoGenerateColumns="False"
                      HeadersVisibility="Column"
                      IsReadOnly="True"
                      CanUserAddRows="False"
                      CanUserDeleteRows="False"
                      GridLinesVisibility="None"
                      RowStyle="{StaticResource RowStyle}"
                      BorderThickness="1"
                      BorderBrush="{StaticResource GridBorderBrush}"
                      Margin="0"
                      RowHeaderWidth="0"
                      ColumnHeaderHeight="30"
                      RowHeight="30"
                      AlternationCount="2"
                      AlternatingRowBackground="#FBFCFE"
                      SelectionMode="Single"
                      SelectionUnit="FullRow">
                <DataGrid.Resources>
                    <Style TargetType="DataGridCell" BasedOn="{StaticResource CellStyle}">
                        <Setter Property="BorderThickness" Value="0,0,0,1"/>
                        <Setter Property="Padding" Value="12,2,12,2"/>
                    </Style>
                </DataGrid.Resources>
                <DataGrid.Columns>
                    <!-- ADDR: 고정 폭(약간 늘림) -->
                    <DataGridTextColumn Header="ADDR" Binding="{Binding Address}" Width="90">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock" BasedOn="{StaticResource AddrText}"/>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- IO NAME: 남는 공간 전부(*) + 최소 220, 툴팁으로 전체 표시 -->
                    <DataGridTextColumn Header="IO NAME" Binding="{Binding IOName}" Width="*"
                                        MinWidth="220">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock" BasedOn="{StaticResource IoNameText}">
                                <Setter Property="ToolTip" Value="{Binding IOName}"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                        <DataGridTextColumn.CellStyle>
                            <Style TargetType="DataGridCell" BasedOn="{StaticResource CellStyleNameCol}"/>
                        </DataGridTextColumn.CellStyle>
                    </DataGridTextColumn>

                    <!-- STAT: 작게 -->
                    <DataGridCheckBoxColumn Header="STAT" Binding="{Binding CurrentState}"
                                            IsReadOnly="True" Width="70"/>

                    <!-- OUTPUT: 버튼 작게 + VM 커맨드로 바인딩 수정 -->
                    <DataGridTemplateColumn Header="OUTPUT" Width="85">
                        <DataGridTemplateColumn.CellStyle>
                            <Style TargetType="DataGridCell" BasedOn="{StaticResource CellStyleOutputCol}"/>
                        </DataGridTemplateColumn.CellStyle>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button Padding="6,2"
                                        MinWidth="64"
                                        FontSize="12"
                                        Command="{Binding DataContext.ToggleOutputCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}">
                                    <Button.Style>
                                        <Style TargetType="Button" BasedOn="{StaticResource ToggleBtnStyle}">
                                            <Setter Property="Padding" Value="6,2"/>
                                            <Setter Property="MinWidth" Value="64"/>
                                            <Setter Property="FontSize" Value="12"/>
                                        </Style>
                                    </Button.Style>
                                </Button>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- CHECK: 작게 -->
                    <DataGridTemplateColumn Header="CHECK" Width="80">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <CheckBox IsChecked="{Binding IsChecked, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                          Focusable="False"
                                          HorizontalAlignment="Center"
                                          VerticalAlignment="Center"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- 메모: 메모 존재 여부에 따라 색/툴팁 변경 -->
                    <DataGridTemplateColumn Header="메모" Width="70">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button Padding="6,2"
                                        MinWidth="56"
                                        FontSize="12"
                                        Command="{Binding DataContext.OpenNoteCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Content" Value="메모"/>
                                            <Setter Property="ToolTip" Value="메모 없음"/>
                                            <Setter Property="Background" Value="{x:Null}"/>
                                            <Setter Property="Foreground"
                                                    Value="{DynamicResource {x:Static SystemColors.ControlTextBrushKey}}"/>
                                            <Style.Triggers>
                                                <!-- 메모가 있을 때 -->
                                                <DataTrigger Binding="{Binding HasNote}" Value="True">
                                                    <Setter Property="Background" Value="#FFFDE9C9"/>
                                                    <Setter Property="Foreground" Value="#B45309"/>
                                                    <Setter Property="ToolTip" Value="메모가 있습니다."/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </DataTemplate>

        <!-- 좌측 탭(DetailUnit만) -->
        <Style x:Key="LeftTabItemStyle" TargetType="TabItem">
            <Setter Property="Width" Value="180"/>
            <Setter Property="Height" Value="34"/>
            <Setter Property="Padding" Value="8,2"/>
        </Style>

        <DataTemplate x:Key="LeftTabHeaderTemplate">
            <TextBlock Text="{Binding Header}" FontSize="13" TextTrimming="CharacterEllipsis"/>
        </DataTemplate>

        <!-- 스크롤 가능한 왼쪽 탭 템플릿 -->
        <Style x:Key="ScrollableLeftTabControl" TargetType="TabControl">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type TabControl}">
                        <Grid ClipToBounds="True">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="12"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- 헤더(왼쪽) -->
                            <Border Grid.Column="0" Background="{TemplateBinding Background}">
                                <ScrollViewer VerticalScrollBarVisibility="Auto"
                                              HorizontalScrollBarVisibility="Disabled"
                                              Focusable="False">
                                    <TabPanel x:Name="HeaderPanel"
                                              Panel.ZIndex="1"
                                              Margin="0"
                                              IsItemsHost="True"
                                              KeyboardNavigation.TabIndex="1"/>
                                </ScrollViewer>
                            </Border>

                            <!-- 구분선 -->
                            <Border Grid.Column="1" Background="#E5E7EB"/>

                            <!-- 컨텐츠 -->
                            <ContentPresenter x:Name="PART_SelectedContentHost"
                                              Grid.Column="2"
                                              Margin="0"
                                              ContentSource="SelectedContent"/>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 상단 버튼 -->
        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
            <Button Content="저장하기"
                    Command="{Binding SaveCommand}"
                    Margin="0,0,8,0"/>

            <Button Content="불러오기"
                    Command="{Binding LoadStateCommand}"
                    Margin="0,0,8,0"/>

            <Button Content="도움말"
                    Command="{Binding HelpCommand}"
                    Margin="0,0,16,0"/>

            <!-- 추가: Check 관련 4개 버튼 (Spare 제외) -->
            <Button Content="Check 전체 선택"
                    Command="{Binding CheckAllCommand}"
                    Margin="0,0,8,0"
                    ToolTip="전체 IO 중 Spare를 제외하고 체크합니다."/>

            <Button Content="Check 전체 해제"
                    Command="{Binding UncheckAllCommand}"
                    Margin="0,0,16,0"
                    ToolTip="전체 IO 중 Spare를 제외하고 체크를 해제합니다."/>

            <Button Content="현재 탭 Check 전체 선택"
                    Command="{Binding CheckCurrentTabCommand}"
                    Margin="0,0,8,0"
                    ToolTip="현재 탭의 IO 중 Spare를 제외하고 체크합니다."/>

            <Button Content="현재 탭 Check 전체 해제"
                    Command="{Binding UncheckCurrentTabCommand}"
                    Margin="0,0,0,0"
                    ToolTip="현재 탭의 IO 중 Spare를 제외하고 체크를 해제합니다."/>
        </StackPanel>

        <!-- 탭 (좌:헤더/우:내용) -->
        <TabControl Grid.Row="1"
                    ItemsSource="{Binding Tabs}"
                    SelectedItem="{Binding SelectedTab, Mode=TwoWay}"
                    TabStripPlacement="Left"
                    ItemContainerStyle="{StaticResource LeftTabItemStyle}"
                    ItemTemplate="{StaticResource LeftTabHeaderTemplate}"
                    Style="{StaticResource ScrollableLeftTabControl}">
            <TabControl.ContentTemplate>
                <DataTemplate>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="12"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- 좌 16 -->
                        <ContentControl Content="{Binding Left16}"
                                        ContentTemplate="{StaticResource SixteenGridSideTemplate16}"/>
                        <Grid Grid.Column="1"/>
                        <!-- 우 16 -->
                        <ContentControl Grid.Column="2"
                                        Content="{Binding Right16}"
                                        ContentTemplate="{StaticResource SixteenGridSideTemplate16}"/>
                    </Grid>
                </DataTemplate>
            </TabControl.ContentTemplate>
        </TabControl>

        <!-- 하단 상태/경로 -->
        <DockPanel Grid.Row="2" Margin="0,8,0,0">
            <TextBlock DockPanel.Dock="Left"
                       Text="{Binding HwStatusText}"
                       Foreground="{Binding HwStatusBrush}"
                       FontWeight="SemiBold"
                       Margin="0,0,12,0"/>
            <TextBlock Text="{Binding StateFilePath}" Foreground="#6B7280" FontSize="11"/>
        </DockPanel>
    </Grid>
</UserControl>
